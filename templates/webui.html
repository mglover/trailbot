<!DOCTYPE html>
<html>

<head>
<!--link rel="stylesheet" href="/static/style.css"-->
<style>
#content {
    max-height: 100vh;
}
#banner, #session {
    width: 90%;
    max-width: 40em;
    margin: auto;
    padding: 1em;
}
#banner {
    background: grey;
    max-height: 30vh;
}
#session {
    background: grey;
}
#log {
    background: black;
    border: 1em solid black;
    height: 70vh;
    min-height: 5em;
    overflow: scroll;
    padding: 1em 0em;
    width: 80%;
    margin: auto;
}
.todo {
    font-family: mono;
    font-size: 80%;
    background: #ffa;
    margin: auto;
    width: 50%;
    text-align: center;
    list-style-type: none;
    padding: 1em;
}
code {
    display: block;
    padding-bottom: 0.2em;
}
.msg {
    padding: 0.5em 1em 0 1em;
    margin-bottom: 0.5em;
    border-radius: 0.5em;
}
.a.msg {
    background: white;
    text-align: right;
}
.b.msg {
    background: grey;
    text-align: left;
}
.status {
    border-top: 2px solid #666;
    font-size: 80%;
}
.status.error::before {
    text-align: left;
    content: "!";
    color: #ff0000;
    font-weight: bold;
    font-size: 150%
}
#input {
    background: white;
     width: 80%;
    margin: 2em auto;
    display: block;

}
</style>
<script>
    inp = null

    function wrap(link) {
        return "<a href=\""+link+"\">"+link+"</a>"
    }

    function markup(str) {
        str = str.replaceAll(" ", "&nbsp;")
        str = str.replaceAll("<", "&lt;")
        str = str.replaceAll(">", "&gt;")
        str = str.replaceAll('\n', '\n<br>')
        link_re = /https*:\/\/[-\/\._A-Za-z0-9]+/g
        str = str.replaceAll(link_re, wrap)
        return str
    }

    function appendMsg(cls, str) {
        var p = document.createElement('div')
        p.className="msg "+cls

        var n = document.createElement('code')
        n.innerHTML=markup(str)

        var s = document.createElement('div')
        s.className="status"

        p.appendChild(n)
        p.appendChild(s)        
        log.appendChild(p)
        log.scrollTop = log.scrollHeight
        return p
    }

    function setStatus(msg, status, isError) {
        var s = msg.children[1]
        if (isError) s.classList.add('error')
        s.innerHTML = status
    }

    function now() {
        var d = new Date()
        var h = d.getHours()
        var m = d.getMinutes()
        if ( h < 10 )
            h = "0" + h
        if ( m < 10 ) 
            m = "0" + m
        return h+':'+m
    }

    function xact(msg) {
        var xhr = new XMLHttpRequest();
        var elMsg = appendMsg('a', msg)
        setStatus(elMsg, "sending...")
        xhr.onload = function () {
            if (xhr.responseText) {
                var m = appendMsg('b', xhr.responseText)
                setStatus(elMsg, now())
                setStatus(m, now())
            }
        }
        xhr.onerror = function () {
            console.log('error')
            setStatus(elMsg, 'failed', true)
        }
        xhr.ontimeout = function () {
            console.log('timeout')
            setStatus(elMsg, 'timeout', true)
        }
        xhr.open("get", "/wx/api?body="+encodeURIComponent(msg));
        xhr.send()
    }

    window.onload = function() {
        log = document.getElementById('log')
        console.log('loaded')
        h = []
        hidx = 0
        inp = document.getElementById('input')
        inp.onkeydown = function (evt) {
            if (evt.key == "Enter") {
                if ( !h.length || h[h.length-1]!=inp.value ) {
                    // keep dups out of the history
                    h.push(inp.value)
                }
                hidx = h.length
                xact(inp.value)
                inp.value = ''
                inp.focus()
            }
            else if (evt.key == "ArrowUp") {
                if (hidx > 0) {
                    inp.value = h[--hidx]
                }
            }
            else if (evt.key == "ArrowDown") {
                if (hidx < h.length-1) {
                    inp.value = h[++hidx]
                } else {
                    inp.value = ''
                    hidx=h.length
                }
            }
        }
        xact('help')
        inp.value = ''
        inp.focus()
    }

</script>
</head>

<body>
<div class="content">
  <div id="banner">
    <p>Trailbot WebUI
  </div>
    <div id="session">
      <div id="log"></div>
       <input autofocus type="text"  id="input"></input>
      </div>
    </div>
</div>
</body>
</html>

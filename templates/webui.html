<html>

<head>
<!--link rel="stylesheet" href="/static/style.css"-->
<style>
#content {
    max-height: 100vh;
}
#banner, #session {
    width: 90%;
    max-width: 40em;
    margin: auto;
    padding: 1em;
}
#banner {
    background: grey;
    max-height: 30vh;
}
#session {
    background: grey;
}
#log {
    background: black;
    border: 1em solid black;
    height: 70vh;
    min-height: 5em;
    overflow: scroll;
    padding: 0.5em;
    width: 80%;
    margin: auto;
}
.todo {
    font-family: mono;
    font-size: 80%;
    background: #ffa;
    margin: auto;
    width: 50%;
    text-align: center;
    list-style-type: none;
    padding: 1em;
}
code {
    display: block;
    padding: .5em;
    margin: .5em;
}
code.a {
    background: white;
    text-align: right;
}
code.b {
    background: grey;
    text-align: left;
}
code.error {
    background: #ffaaaa;
}
#input {
    background: white;
     width: 80%;
    margin: 2em auto;
    display: block;

}
</style>
<script>
    inp = null

    function wrap(link) {
        return "<a href=\""+link+"\">"+link+"</a>"
    }

    function markup(str) {
        str = str.replaceAll("<", "&lt;")
        str = str.replaceAll(">", "&gt;")
        str = str.replaceAll('\n', '\n<br>')
        link_re = /https*:\/\/[-\/\._A-Za-z0-9]+/g
        str = str.replaceAll(link_re, wrap)
        return str
    }

    function appendMsg(cls, str) {
        n = document.createElement('code')
        n.className=cls
        n.innerHTML=markup(str)
        log.appendChild(n)
        log.scrollTop = log.scrollHeight
        return n
    }

    function xact(msg) {
        var xhr = new XMLHttpRequest();
        var elMsg = appendMsg('a', msg)

        xhr.onload = function () {
            if (xhr.responseText) {
                appendMsg('b', xhr.responseText)
            }
        }
        xhr.onerror = function () {
            console.log('error')
            elMsg.classList.add('error')
        }
        xhr.ontimeout = function () {
            console.log('timeout')
            elMsg.classList.add('error')
        }
        xhr.open("get", "/wx/api?body="+encodeURIComponent(msg));
        xhr.send()
    }

    window.onload = function() {
        log = document.getElementById('log')
        console.log('loaded')
        h = []
        hidx = 0
        inp = document.getElementById('input')
        inp.onkeydown = function (evt) {
            if (evt.key == "Enter") {
                h.push(inp.value)
                hidx = h.length
                xact(inp.value)
                inp.value = ''
                inp.focus()
            }
            else if (evt.key == "ArrowUp") {
                if (hidx > 0) {
                    inp.value = h[--hidx]
                }
            }
            else if (evt.key == "ArrowDown") {
                if (hidx < h.length-1) {
                    inp.value = h[++hidx]
                } else {
                    inp.value = ''
                    hidx=h.length
                }
            }
        }
        xact('help')
        inp.value = ''
        inp.focus()
    }

</script>
</head>

<body>
<div class="content">
  <div id="banner">
    <p>Trailbot WebUI
  </div>
    <div id="session">
      <div id="log"></div>
       <input autofocus type="text"  id="input"></input>
      </div>
    </div>
</div>
</body>
</html>
